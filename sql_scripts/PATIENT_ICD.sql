/* Episode Diagnosis Data with Flexible Date Range Handling */
WITH EPISODE_DIAG AS (
    SELECT SPECIALISM, CODE, DATUM,
           IIF(VOLGENDE_DATUM <= EINDDATUM, DATEADD(DAY, -1, VOLGENDE_DATUM), EINDDATUM) AS EINDDATUM, 
           OMSCHRIJV
    FROM (
        SELECT SPECIALISM, CODE,
               ISNULL(DATUM, DATEFROMPARTS(1900,1,1)) AS DATUM,
               ISNULL(EINDDATUM, DATEFROMPARTS(2099,12,31)) AS EINDDATUM,
               LEAD(DATUM) OVER (PARTITION BY SPECIALISM, CODE ORDER BY ISNULL(DATUM, DATEFROMPARTS(1900,1,1))) AS VOLGENDE_DATUM,
               OMSCHRIJV
        FROM dbo.EPISODE_DIAG
    ) s
    WHERE DATUM < VOLGENDE_DATUM OR VOLGENDE_DATUM IS NULL
),

/* Episode Matches for Each Patient and Visit */
episode_matches AS (
    SELECT vv.PATIENTNR, OP.PLANNR, OP.SPECIALISM, ff.EPISODE, ff.HOOFDDIAG, 
           ff.BEGINDAT, ff.EINDDAT, D.ICD10
    FROM [HIX_PRODUCTIE].[dbo].[PATIENT_PATIENT] AS vv
    INNER JOIN OPNAME_OPNAME OP ON vv.PATIENTNR = OP.PATIENTNR
        AND OP.SPECIALISM IN ('ORT', 'HLK', 'CHI', 'CHIR')
    LEFT JOIN dbo.EPISODE_EPISODE AS ss ON vv.PATIENTNR = ss.PATIENTNR
    LEFT JOIN EPISODE_DBCPER AS ff ON ff.EPISODE = ss.EPISODE
        AND OP.OPNDAT BETWEEN ff.BEGINDAT AND ISNULL(ff.EINDDAT, DATEFROMPARTS(2099,12,31))
        AND OP.ONTSLDAT BETWEEN ff.BEGINDAT AND ISNULL(ff.EINDDAT, DATEFROMPARTS(2099,12,31))
    LEFT JOIN EPISODE_DBCPER AS D ON D.EPISODE = ff.EPISODE
),

/* ICD Matches CTE to Capture All ICD Code Options for Each Visit */
icd_matches AS (
    SELECT em.PLANNR, em.PATIENTNR,
           em.BEGINDAT, em.EINDDAT, 
           em.ICD10 AS ICD_CODE, 
           ROW_NUMBER() OVER (PARTITION BY em.PLANNR ORDER BY em.BEGINDAT DESC, em.EINDDAT DESC) AS rn
    FROM episode_matches em
    LEFT JOIN EPISODE_DIAG ED ON ED.CODE = em.HOOFDDIAG 
        AND ED.SPECIALISM = em.SPECIALISM
        AND (em.BEGINDAT BETWEEN ED.DATUM AND ED.EINDDATUM 
             OR em.EINDDAT BETWEEN ED.DATUM AND ED.EINDDATUM)
)

/* Final Query - Filter for Top ICD Code Result per Visit */
SELECT 
	--For exporting everything should be hashed, but when debugging for specific patients you should not.
	--HASHBYTES('SHA2_256', PATIENTNR) AS PATIENTNR,
	PATIENTNR AS PATIENTNR,
	PLANNR AS VISITNR,
	--BEGINDAT,
	--EINDDAT,
	ICD_CODE
FROM icd_matches
WHERE rn = 1
AND BEGINDAT BETWEEN '20120601' AND '20240101'
AND ICD_CODE IS NOT NULL;